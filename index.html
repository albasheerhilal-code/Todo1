<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… - Ø´Ø§Ø±Ùƒ Ù…Ø¹ ÙØ±ÙŠÙ‚Ùƒ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(to right, #2c3e50, #4a6491);
            color: white;
            padding: 30px;
            text-align: center;
            border-bottom: 5px solid #3498db;
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        .section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }

        .section-title {
            color: #2c3e50;
            font-size: 1.8rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: #3498db;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        input, textarea, select {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1.1rem;
            transition: all 0.3s;
            background: white;
        }

        input:focus, textarea:focus, select:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #219653;
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-secondary {
            background: #7f8c8d;
        }

        .btn-secondary:hover {
            background: #636e72;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .users-management {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px dashed #ddd;
        }

        .users-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .user-tag {
            background: #e3f2fd;
            padding: 8px 15px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            border: 2px solid #bbdefb;
        }

        .user-tag .remove-user {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            font-size: 1rem;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .user-tag .remove-user:hover {
            background: #e74c3c;
            color: white;
        }

        .user-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-block;
        }

        .todos-container {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .todos-container::-webkit-scrollbar {
            width: 8px;
        }

        .todos-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .todos-container::-webkit-scrollbar-thumb {
            background: #bdc3c7;
            border-radius: 10px;
        }

        .todo-item {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-right: 5px solid #3498db;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
            position: relative;
        }

        .todo-item:hover {
            transform: translateX(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .todo-item.completed {
            opacity: 0.8;
            border-right-color: #27ae60;
            background: #f8fff9;
        }

        .todo-item.completed .todo-text {
            text-decoration: line-through;
            color: #7f8c8d;
        }

        .todo-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .todo-text {
            font-size: 1.2rem;
            font-weight: 500;
            color: #2c3e50;
            flex: 1;
            margin-left: 15px;
        }

        .todo-checkbox {
            width: 22px;
            height: 22px;
            cursor: pointer;
        }

        .todo-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .todo-person {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .todo-date {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .todo-actions {
            display: flex;
            gap: 8px;
        }

        .empty-todos {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }

        .empty-todos i {
            font-size: 3.5rem;
            margin-bottom: 15px;
            color: #bdc3c7;
        }

        .empty-todos p {
            font-size: 1.2rem;
        }

        .sharing-section {
            background: #e8f4fc;
            padding: 25px;
            margin: 30px;
            border-radius: 12px;
            border: 2px dashed #3498db;
        }

        .sharing-title {
            color: #2c3e50;
            font-size: 1.6rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sharing-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .sharing-options {
                grid-template-columns: 1fr;
            }
        }

        .share-link-container {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .share-link-container input {
            flex: 1;
            font-family: monospace;
            background: white;
        }

        .share-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            background: #2c3e50;
            color: white;
            padding: 20px;
            margin-top: 30px;
            border-radius: 10px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            display: block;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .current-users {
            margin-top: 20px;
            padding: 15px;
            background: #fffde7;
            border-radius: 8px;
            border: 1px solid #ffeb3b;
        }

        .current-users h4 {
            color: #f57c00;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            border-top: 1px solid #eee;
            background: #f8f9fa;
        }

        /* Modal for adding new users */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #2c3e50;
            font-size: 1.8rem;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: #7f8c8d;
            cursor: pointer;
        }

        .close-modal:hover {
            color: #e74c3c;
        }

        .color-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
        }

        .color-option.selected {
            border-color: #2c3e50;
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©</h1>
            <p>Ù†Ø¸Ù… Ù…Ù‡Ø§Ù…Ùƒ ÙˆØ´Ø§Ø±ÙƒÙ‡Ø§ Ù…Ø¹ ÙØ±ÙŠÙ‚Ùƒ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</p>
        </div>

        <div class="main-content">
            <div class="section">
                <h2 class="section-title"><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
                
                <div class="input-group">
                    <label for="task-input">Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù‡Ù…Ø© Ù‡Ù†Ø§:</label>
                    <textarea id="task-input" placeholder="Ù…Ø«Ø§Ù„: Ø¥Ø¹Ø¯Ø§Ø¯ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ… Ù„Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ Ø§Ù„Ù‚Ø§Ø¯Ù…..."></textarea>
                </div>
                
                <div class="input-group">
                    <label for="person-select">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</label>
                    <select id="person-select">
                        <option value="">-- Ø§Ø®ØªØ± Ø´Ø®Øµ --</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <button id="add-task-btn" class="btn btn-success">
                        <i class="fas fa-plus"></i> Ø£Ø¶Ù Ø§Ù„Ù…Ù‡Ù…Ø©
                    </button>
                    <button id="add-user-btn" class="btn btn-secondary">
                        <i class="fas fa-user-plus"></i> Ø£Ø¶Ù Ø´Ø®Øµ Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
                
                <div class="users-management">
                    <h3 class="section-title"><i class="fas fa-users"></i> ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„</h3>
                    <div class="users-list" id="users-list">
                        <!-- Users will be added here dynamically -->
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2 class="section-title"><i class="fas fa-tasks"></i> Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2>
                
                <div class="todos-container" id="todos-container">
                    <!-- Todos will be added here dynamically -->
                    <div class="empty-todos">
                        <i class="fas fa-clipboard-list"></i>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©!</p>
                    </div>
                </div>
                
                <div class="current-users" id="current-users-section">
                    <h4><i class="fas fa-user-check"></i> Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹:</h4>
                    <div id="current-users-list">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø¨Ø¹Ø¯</div>
                </div>
                
                <div class="share-actions">
                    <button id="clear-completed-btn" class="btn btn-secondary">
                        <i class="fas fa-check-double"></i> Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©
                    </button>
                    <button id="clear-all-btn" class="btn btn-danger">
                        <i class="fas fa-trash-alt"></i> Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù…
                    </button>
                </div>
            </div>
        </div>
        
        <div class="sharing-section">
            <h2 class="sharing-title"><i class="fas fa-share-alt"></i> Ø´Ø§Ø±Ùƒ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</h2>
            <p>Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ø¯Ù†Ø§Ù‡ ÙˆØ£Ø±Ø³Ù„Ù‡ Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙØ±ÙŠÙ‚Ùƒ Ù„ÙŠØªÙ…ÙƒÙ†ÙˆØ§ Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ù†ÙØ³Ù‡Ø§:</p>
            
            <div class="share-link-container">
                <input type="text" id="share-link" readonly>
                <button id="copy-link-btn" class="btn btn-success">
                    <i class="fas fa-copy"></i> Ù†Ø³Ø®
                </button>
            </div>
            
            <div class="share-actions">
                <button id="generate-new-link" class="btn">
                    <i class="fas fa-link"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯
                </button>
                <button id="import-link-btn" class="btn btn-secondary">
                    <i class="fas fa-download"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ø±Ø§Ø¨Ø·
                </button>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-item">
                <span class="stat-number" id="total-tasks">0</span>
                <span class="stat-label">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="completed-tasks">0</span>
                <span class="stat-label">Ù…ÙƒØªÙ…Ù„Ø©</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="pending-tasks">0</span>
                <span class="stat-label">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="team-count">0</span>
                <span class="stat-label">Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„ÙØ±ÙŠÙ‚</span>
            </div>
        </div>
        
        <div class="footer">
            <p>ØªØ·Ø¨ÙŠÙ‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© | ÙŠØ¯Ø¹Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¨ÙŠÙ† Ø¹Ø¯Ø© Ø£Ø´Ø®Ø§Øµ</p>
            <p>ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙŠ Ù…ØªØµÙØ­Ùƒ ÙˆØªØ­Ø¯ÙŠØ«Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</p>
        </div>
    </div>
    
    <!-- Modal for adding new users -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯ Ù„Ù„ÙØ±ÙŠÙ‚</h3>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="input-group">
                <label for="new-user-name">Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ:</label>
                <input type="text" id="new-user-name" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ø¬Ø¯ÙŠØ¯">
            </div>
            
            <div class="input-group">
                <label>Ø§Ø®ØªØ± Ù„ÙˆÙ†Ø§Ù‹ Ù„Ù„Ø¹Ø¶Ùˆ:</label>
                <div class="color-options" id="color-options">
                    <!-- Color options will be generated by JS -->
                </div>
            </div>
            
            <button id="save-user-btn" class="btn btn-success">
                <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¹Ø¶Ùˆ
            </button>
        </div>
    </div>

    <!-- Modal for importing shared list -->
    <div id="import-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ù…Ø´ØªØ±ÙƒØ©</h3>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="input-group">
                <label for="import-link-input">Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©:</label>
                <input type="text" id="import-link-input" placeholder="https://example.com?list=...">
            </div>
            
            <p style="margin: 15px 0; color: #e74c3c; font-weight: bold;">
                âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø³ÙŠØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©!
            </p>
            
            <button id="confirm-import-btn" class="btn btn-success">
                <i class="fas fa-download"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            </button>
        </div>
    </div>

    <script>
        // Application state
        const state = {
            todos: [],
            users: [],
            currentListId: null,
            selectedColor: '#3498db'
        };

        // Color options for users
        const colorOptions = [
            '#3498db', '#e74c3c', '#2ecc71', '#f39c12', 
            '#9b59b6', '#1abc9c', '#d35400', '#34495e',
            '#e67e22', '#27ae60', '#8e44ad', '#16a085'
        ];

        // DOM elements
        const dom = {
            taskInput: document.getElementById('task-input'),
            personSelect: document.getElementById('person-select'),
            addTaskBtn: document.getElementById('add-task-btn'),
            addUserBtn: document.getElementById('add-user-btn'),
            usersList: document.getElementById('users-list'),
            todosContainer: document.getElementById('todos-container'),
            currentUsersList: document.getElementById('current-users-list'),
            currentUsersSection: document.getElementById('current-users-section'),
            clearCompletedBtn: document.getElementById('clear-completed-btn'),
            clearAllBtn: document.getElementById('clear-all-btn'),
            shareLink: document.getElementById('share-link'),
            copyLinkBtn: document.getElementById('copy-link-btn'),
            generateNewLinkBtn: document.getElementById('generate-new-link'),
            importLinkBtn: document.getElementById('import-link-btn'),
            totalTasks: document.getElementById('total-tasks'),
            completedTasks: document.getElementById('completed-tasks'),
            pendingTasks: document.getElementById('pending-tasks'),
            teamCount: document.getElementById('team-count'),
            userModal: document.getElementById('user-modal'),
            importModal: document.getElementById('import-modal'),
            newUserName: document.getElementById('new-user-name'),
            colorOptions: document.getElementById('color-options'),
            saveUserBtn: document.getElementById('save-user-btn'),
            closeModalBtns: document.querySelectorAll('.close-modal'),
            importLinkInput: document.getElementById('import-link-input'),
            confirmImportBtn: document.getElementById('confirm-import-btn')
        };

        // Initialize the application
        function init() {
            // Load data from localStorage
            loadData();
            
            // Generate initial list ID if not exists
            if (!state.currentListId) {
                state.currentListId = generateListId();
                saveData();
            }
            
            // Update UI
            updateShareLink();
            renderUsers();
            renderTodos();
            updateStats();
            
            // Set up event listeners
            setupEventListeners();
            
            // Simulate real-time updates (in a real app, this would be WebSockets)
            simulateRealtimeUpdates();
        }

        // Generate a unique list ID
        function generateListId() {
            return 'list_' + Date.now() + '_' + Math.random().toString(36).substring(2, 15);
        }

        // Load data from localStorage
        function loadData() {
            // Try to get list ID from URL first
            const urlParams = new URLSearchParams(window.location.search);
            const listIdFromUrl = urlParams.get('list');
            
            if (listIdFromUrl) {
                state.currentListId = listIdFromUrl;
            } else {
                // Get from localStorage
                state.currentListId = localStorage.getItem('currentListId');
            }
            
            // Load todos and users for this list
            const todosKey = `todos_${state.currentListId}`;
            const usersKey = `users_${state.currentListId}`;
            
            state.todos = JSON.parse(localStorage.getItem(todosKey)) || [];
            state.users = JSON.parse(localStorage.getItem(usersKey)) || [];
            
            // If no users, add default ones
            if (state.users.length === 0) {
                state.users = [
                    { id: 1, name: 'Ø£Ø­Ù…Ø¯', color: '#3498db' },
                    { id: 2, name: 'Ø³Ø§Ø±Ø©', color: '#e74c3c' },
                    { id: 3, name: 'Ù…Ø­Ù…Ø¯', color: '#2ecc71' }
                ];
                saveData();
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('currentListId', state.currentListId);
            
            const todosKey = `todos_${state.currentListId}`;
            const usersKey = `users_${state.currentListId}`;
            
            localStorage.setItem(todosKey, JSON.stringify(state.todos));
            localStorage.setItem(usersKey, JSON.stringify(state.users));
            
            // Update URL without reloading
            const newUrl = window.location.origin + window.location.pathname + '?list=' + state.currentListId;
            window.history.replaceState({}, document.title, newUrl);
        }

        // Update the share link
        function updateShareLink() {
            const baseUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${baseUrl}?list=${state.currentListId}`;
            dom.shareLink.value = shareUrl;
        }

        // Render users list
        function renderUsers() {
            // Clear existing options
            dom.personSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø´Ø®Øµ --</option>';
            dom.usersList.innerHTML = '';
            
            // Add users to select
            state.users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                dom.personSelect.appendChild(option);
            });
            
            // Render users as tags
            state.users.forEach(user => {
                const userTag = document.createElement('div');
                userTag.className = 'user-tag';
                userTag.innerHTML = `
                    <span class="user-color" style="background-color: ${user.color}"></span>
                    ${user.name}
                    ${user.id > 3 ? `<button class="remove-user" data-id="${user.id}">&times;</button>` : ''}
                `;
                dom.usersList.appendChild(userTag);
            });
            
            // Add event listeners for remove buttons
            document.querySelectorAll('.remove-user').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = parseInt(this.getAttribute('data-id'));
                    removeUser(userId);
                });
            });
        }

        // Render todos list
        function renderTodos() {
            if (state.todos.length === 0) {
                dom.todosContainer.innerHTML = `
                    <div class="empty-todos">
                        <i class="fas fa-clipboard-list"></i>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©!</p>
                    </div>
                `;
                dom.currentUsersSection.style.display = 'none';
                return;
            }
            
            dom.todosContainer.innerHTML = '';
            dom.currentUsersSection.style.display = 'block';
            
            // Get unique users from todos
            const activeUsers = new Set();
            
            state.todos.forEach(todo => {
                const user = state.users.find(u => u.id === todo.userId);
                if (user) activeUsers.add(user.name);
                
                const todoElement = document.createElement('div');
                todoElement.className = `todo-item ${todo.completed ? 'completed' : ''}`;
                todoElement.innerHTML = `
                    <div class="todo-header">
                        <input type="checkbox" class="todo-checkbox" ${todo.completed ? 'checked' : ''} data-id="${todo.id}">
                        <div class="todo-text">${todo.text}</div>
                    </div>
                    <div class="todo-meta">
                        <div class="todo-person">
                            <span class="user-color" style="background-color: ${user?.color || '#ccc'}"></span>
                            ${user?.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                        </div>
                        <div class="todo-date">${formatDate(todo.createdAt)}</div>
                        <div class="todo-actions">
                            <button class="btn btn-small btn-danger delete-todo" data-id="${todo.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                dom.todosContainer.appendChild(todoElement);
            });
            
            // Update current users list
            dom.currentUsersList.innerHTML = Array.from(activeUsers).map(name => 
                `<span style="margin-left: 10px; font-weight: bold;">${name}</span>`
            ).join('ØŒ ') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø¨Ø¹Ø¯';
            
            // Add event listeners
            document.querySelectorAll('.todo-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const todoId = parseInt(this.getAttribute('data-id'));
                    toggleTodoCompletion(todoId);
                });
            });
            
            document.querySelectorAll('.delete-todo').forEach(btn => {
                btn.addEventListener('click', function() {
                    const todoId = parseInt(this.getAttribute('data-id'));
                    removeTodo(todoId);
                });
            });
        }

        // Format date for display
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Ø§Ù„Ø¢Ù†';
            if (diffMins < 60) return `Ù‚Ø¨Ù„ ${diffMins} Ø¯Ù‚ÙŠÙ‚Ø©`;
            if (diffHours < 24) return `Ù‚Ø¨Ù„ ${diffHours} Ø³Ø§Ø¹Ø©`;
            if (diffDays === 1) return 'Ø£Ù…Ø³';
            if (diffDays < 7) return `Ù‚Ø¨Ù„ ${diffDays} ÙŠÙˆÙ…`;
            
            return date.toLocaleDateString('ar-EG');
        }

        // Update statistics
        function updateStats() {
            const total = state.todos.length;
            const completed = state.todos.filter(todo => todo.completed).length;
            const pending = total - completed;
            
            dom.totalTasks.textContent = total;
            dom.completedTasks.textContent = completed;
            dom.pendingTasks.textContent = pending;
            dom.teamCount.textContent = state.users.length;
        }

        // Add a new todo
        function addTodo() {
            const text = dom.taskInput.value.trim();
            const userId = parseInt(dom.personSelect.value);
            
            if (!text) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ù…Ù‡Ù…Ø©');
                dom.taskInput.focus();
                return;
            }
            
            if (!userId) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø´Ø®Øµ Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„Ù…Ù‡Ù…Ø©');
                dom.personSelect.focus();
                return;
            }
            
            const newTodo = {
                id: Date.now(),
                text,
                userId,
                completed: false,
                createdAt: Date.now()
            };
            
            state.todos.unshift(newTodo);
            saveData();
            renderTodos();
            updateStats();
            
            // Clear input
            dom.taskInput.value = '';
            dom.taskInput.focus();
        }

        // Toggle todo completion
        function toggleTodoCompletion(todoId) {
            const todo = state.todos.find(t => t.id === todoId);
            if (todo) {
                todo.completed = !todo.completed;
                saveData();
                renderTodos();
                updateStats();
            }
        }

        // Remove a todo
        function removeTodo(todoId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ')) return;
            
            state.todos = state.todos.filter(t => t.id !== todoId);
            saveData();
            renderTodos();
            updateStats();
        }

        // Add a new user
        function addUser() {
            dom.userModal.style.display = 'flex';
            dom.newUserName.focus();
            
            // Generate color options
            dom.colorOptions.innerHTML = '';
            colorOptions.forEach(color => {
                const colorOption = document.createElement('div');
                colorOption.className = `color-option ${color === state.selectedColor ? 'selected' : ''}`;
                colorOption.style.backgroundColor = color;
                colorOption.setAttribute('data-color', color);
                dom.colorOptions.appendChild(colorOption);
            });
        }

        // Save new user
        function saveUser() {
            const name = dom.newUserName.value.trim();
            
            if (!name) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ');
                dom.newUserName.focus();
                return;
            }
            
            // Check if user already exists
            if (state.users.some(user => user.name === name)) {
                alert('Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„!');
                return;
            }
            
            const newUser = {
                id: Date.now(),
                name,
                color: state.selectedColor
            };
            
            state.users.push(newUser);
            saveData();
            renderUsers();
            updateStats();
            
            // Close modal and reset
            dom.userModal.style.display = 'none';
            dom.newUserName.value = '';
            state.selectedColor = '#3498db';
        }

        // Remove a user
        function removeUser(userId) {
            // Check if user has any todos
            const userTodos = state.todos.filter(todo => todo.userId === userId);
            
            if (userTodos.length > 0) {
                if (!confirm(`Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ${userTodos.length} Ù…Ù‡Ù…Ø©. Ø­Ø°ÙÙ‡ Ø³ÙŠØ­Ø°Ù Ù…Ù‡Ø§Ù…Ù‡ Ø£ÙŠØ¶Ø§Ù‹. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`)) {
                    return;
                }
                
                // Remove user's todos
                state.todos = state.todos.filter(todo => todo.userId !== userId);
            }
            
            // Remove user
            state.users = state.users.filter(user => user.id !== userId);
            saveData();
            renderUsers();
            renderTodos();
            updateStats();
        }

        // Clear completed todos
        function clearCompletedTodos() {
            const completedCount = state.todos.filter(todo => todo.completed).length;
            
            if (completedCount === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…ÙƒØªÙ…Ù„Ø© Ù„Ø­Ø°ÙÙ‡Ø§');
                return;
            }
            
            if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù ${completedCount} Ù…Ù‡Ù…Ø© Ù…ÙƒØªÙ…Ù„Ø©ØŸ`)) {
                state.todos = state.todos.filter(todo => !todo.completed);
                saveData();
                renderTodos();
                updateStats();
            }
        }

        // Clear all todos
        function clearAllTodos() {
            if (state.todos.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù„Ø­Ø°ÙÙ‡Ø§');
                return;
            }
            
            if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù… (${state.todos.length} Ù…Ù‡Ù…Ø©)ØŸ`)) {
                state.todos = [];
                saveData();
                renderTodos();
                updateStats();
            }
        }

        // Copy share link to clipboard
        function copyShareLink() {
            dom.shareLink.select();
            dom.shareLink.setSelectionRange(0, 99999);
            
            navigator.clipboard.writeText(dom.shareLink.value)
                .then(() => {
                    const originalText = dom.copyLinkBtn.innerHTML;
                    dom.copyLinkBtn.innerHTML = '<i class="fas fa-check"></i> ØªÙ… Ø§Ù„Ù†Ø³Ø®!';
                    dom.copyLinkBtn.classList.add('btn-success');
                    
                    setTimeout(() => {
                        dom.copyLinkBtn.innerHTML = originalText;
                        dom.copyLinkBtn.classList.remove('btn-success');
                    }, 2000);
                })
                .catch(err => {
                    console.error('Failed to copy: ', err);
                    alert('ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                });
        }

        // Generate new list ID
        function generateNewList() {
            if (confirm('Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø³ÙŠØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) {
                state.currentListId = generateListId();
                state.todos = [];
                saveData();
                updateShareLink();
                renderTodos();
                updateStats();
                alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù†Ø¬Ø§Ø­! Ø´Ø§Ø±Ùƒ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ ÙØ±ÙŠÙ‚Ùƒ.');
            }
        }

        // Import from shared link
        function importFromLink() {
            dom.importModal.style.display = 'flex';
            dom.importLinkInput.focus();
        }

        // Confirm import
        function confirmImport() {
            const importUrl = dom.importLinkInput.value.trim();
            
            if (!importUrl) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©');
                return;
            }
            
            // Extract list ID from URL
            const urlParams = new URLSearchParams(importUrl.split('?')[1]);
            const listId = urlParams.get('list');
            
            if (!listId) {
                alert('Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·');
                return;
            }
            
            // Load data from the shared list
            const todosKey = `todos_${listId}`;
            const usersKey = `users_${listId}`;
            
            const sharedTodos = JSON.parse(localStorage.getItem(todosKey));
            const sharedUsers = JSON.parse(localStorage.getItem(usersKey));
            
            if (!sharedTodos || !sharedUsers) {
                alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø·. Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø­Ø°ÙˆÙØ© Ø£Ùˆ Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­.');
                return;
            }
            
            // Confirm import
            if (confirm(`Ø³ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${sharedTodos.length} Ù…Ù‡Ù…Ø© Ùˆ ${sharedUsers.length} Ø¹Ø¶Ùˆ. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`)) {
                state.currentListId = listId;
                state.todos = sharedTodos;
                state.users = sharedUsers;
                saveData();
                updateShareLink();
                renderUsers();
                renderTodos();
                updateStats();
                dom.importModal.style.display = 'none';
                dom.importLinkInput.value = '';
                alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­!');
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Add task
            dom.addTaskBtn.addEventListener('click', addTodo);
            dom.taskInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addTodo();
                }
            });
            
            // Add user
            dom.addUserBtn.addEventListener('click', addUser);
            
            // Save user
            dom.saveUserBtn.addEventListener('click', saveUser);
            
            // Color selection
            dom.colorOptions.addEventListener('click', function(e) {
                if (e.target.classList.contains('color-option')) {
                    // Remove selected class from all
                    document.querySelectorAll('.color-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Add to clicked
                    e.target.classList.add('selected');
                    state.selectedColor = e.target.getAttribute('data-color');
                }
            });
            
            // Clear todos
            dom.clearCompletedBtn.addEventListener('click', clearCompletedTodos);
            dom.clearAllBtn.addEventListener('click', clearAllTodos);
            
            // Share link
            dom.copyLinkBtn.addEventListener('click', copyShareLink);
            dom.generateNewLinkBtn.addEventListener('click', generateNewList);
            dom.importLinkBtn.addEventListener('click', importFromLink);
            
            // Close modals
            dom.closeModalBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    dom.userModal.style.display = 'none';
                    dom.importModal.style.display = 'none';
                });
            });
            
            // Confirm import
            dom.confirmImportBtn.addEventListener('click', confirmImport);
            
            // Close modals when clicking outside
            window.addEventListener('click', function(e) {
                if (e.target === dom.userModal) {
                    dom.userModal.style.display = 'none';
                }
                if (e.target === dom.importModal) {
                    dom.importModal.style.display = 'none';
                }
            });
        }

        // Simulate real-time updates (for demo purposes)
        function simulateRealtimeUpdates() {
            // Check for updates every 5 seconds
            setInterval(() => {
                // In a real app, this would check a server for updates
                // For this demo, we'll just reload from localStorage
                loadData();
                renderTodos();
                updateStats();
            }, 5000);
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
